"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9879],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return m}});var l=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);t&&(l=l.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,l)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,l,a=function(e,t){if(null==e)return{};var n,l,a={},r=Object.keys(e);for(l=0;l<r.length;l++)n=r[l],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(l=0;l<r.length;l++)n=r[l],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=l.createContext({}),u=function(e){var t=l.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=u(e.components);return l.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return l.createElement(l.Fragment,{},t)}},d=l.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=u(n),m=a,f=d["".concat(s,".").concat(m)]||d[m]||p[m]||r;return n?l.createElement(f,i(i({ref:t},c),{},{components:n})):l.createElement(f,i({ref:t},c))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:a,i[1]=o;for(var u=2;u<r;u++)i[u]=n[u];return l.createElement.apply(null,i)}return l.createElement.apply(null,n)}d.displayName="MDXCreateElement"},4669:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return s},metadata:function(){return u},toc:function(){return c},default:function(){return d}});var l=n(7462),a=n(3366),r=(n(7294),n(3905)),i=["components"],o={id:"install-metallb",title:"Install MetalLB"},s=void 0,u={unversionedId:"Kubernetes-Advanced/install-metallb",id:"Kubernetes-Advanced/install-metallb",isDocsHomePage:!1,title:"Install MetalLB",description:"MetalLB est un service de load-balancer pour cluster bare metal Kubernetes.",source:"@site/docs/Kubernetes-Advanced/install-metallb.md",sourceDirName:"Kubernetes-Advanced",slug:"/Kubernetes-Advanced/install-metallb",permalink:"/docs/Kubernetes-Advanced/install-metallb",editUrl:"https://github.com/j-peguet/portfolio/blob/master/docs/Kubernetes-Advanced/install-metallb.md",tags:[],version:"current",lastUpdatedAt:1630868816,formattedLastUpdatedAt:"9/5/2021",frontMatter:{id:"install-metallb",title:"Install MetalLB"},sidebar:"docs",previous:{title:"Install Kubespray",permalink:"/docs/Kubernetes-Advanced/install-kubespray"},next:{title:"Install Traefik",permalink:"/docs/Kubernetes-Advanced/install-traefik"}},c=[{value:"Installation de MetalLB",id:"installation-de-metallb",children:[{value:"Pr\xe9requis",id:"pr\xe9requis",children:[],level:3},{value:"R\xe9cup\xe9ration de l&#39;outil",id:"r\xe9cup\xe9ration-de-loutil",children:[],level:3}],level:2},{value:"Configuration",id:"configuration",children:[],level:2},{value:"Utilisation",id:"utilisation",children:[],level:2}],p={toc:c};function d(e){var t=e.components,o=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,l.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"MetalLB est un service de load-balancer pour cluster bare metal Kubernetes."),(0,r.kt)("p",null,'Il permet de configurer un service load balancer avec les services qui seront d\xe9ploy\xe9s sur le cluster.\nCe service permet de compenser les inconv\xe9nients des outils "NodePort" et "externalIPs", qui limitent une bonne utilistion en production.'),(0,r.kt)("p",null,"Lien vers la documentation officielle: ",(0,r.kt)("a",{parentName:"p",href:"https://metallb.universe.tf/installation/"},"https://metallb.universe.tf/installation/")),(0,r.kt)("h2",{id:"installation-de-metallb"},"Installation de MetalLB"),(0,r.kt)("p",null,"Ces \xe9tapes sont \xe0 faire sur la machine Master uniquement."),(0,r.kt)("h3",{id:"pr\xe9requis"},"Pr\xe9requis"),(0,r.kt)("p",null,"Si vous utiliser kube-proxy en mode IPVS, depuis Kubernetes v1.14.2 il faut obligatoirement activer le mode ",(0,r.kt)("code",null,"strictARP"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo kubectl edit configmap -n kube-system kube-proxy\n")),(0,r.kt)("p",null,"Et modifier les lignes suivantes: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'apiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nmode: "ipvs"\nipvs:\n  strictARP: true\n')),(0,r.kt)("h3",{id:"r\xe9cup\xe9ration-de-loutil"},"R\xe9cup\xe9ration de l'outil"),(0,r.kt)("p",null,"Nous allons cr\xe9er un dossier contenant les fichiers de configuration de MetalLB. Puis t\xe9l\xe9charger et ex\xe9cuter les fichiers yaml."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir metallb\ncd metallb\nwget https://raw.githubusercontent.com/metallb/metallb/v0.9.6/manifests/namespace.yaml\nwget https://raw.githubusercontent.com/metallb/metallb/v0.9.6/manifests/metallb.yaml\n\nsudo kubectl apply -f namespace.yaml\nsudo kubectl apply -f metallb.yaml\n")),(0,r.kt)("p",null,"Si c'est la premi\xe8re fois que vous installer MetalLB sur le cluster, il faut cr\xe9er un secret sp\xe9cifique (cette action n'est donc pas \xe0 faire en cas de r\xe9installation ou de mise \xe0 jour)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'sudo kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)"\n')),(0,r.kt)("p",null,"Pour controler que l'installation c'est correctement d\xe9roul\xe9e: "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo kubectl get pods -n  metallb-system -o wide\n")),(0,r.kt)("p",null,"La r\xe9ponse de l'ex\xe9cution doit donner:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"1 controller"),(0,r.kt)("li",{parentName:"ul"},"1 speaker par node")),(0,r.kt)("p",null,"Tous les pods doivent avoir le status ",(0,r.kt)("em",{parentName:"p"},"running"),"."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"metallb pods",src:n(6234).Z})),(0,r.kt)("h2",{id:"configuration"},"Configuration"),(0,r.kt)("p",null,"Dans ce tuto nous allons utiliser la configuration la plus simple \xe0 mettre en place: ",(0,r.kt)("code",null,"layer2"),".\nD'autres configurations sont disponibles ",(0,r.kt)("a",{parentName:"p",href:"https://metallb.universe.tf/configuration/"},"ici")," (ex: BGP)."),(0,r.kt)("p",null,"Il suffit de cr\xe9er un fichier metallb-config.yaml."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo nano metallb-config.yaml\n")),(0,r.kt)("p",null,"Et de modifier la range IP selon votre reseau."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  namespace: metallb-system\n  name: config\ndata:\n  config: |\n    address-pools:\n    - name: default\n      protocol: layer2\n      addresses:\n      - 192.168.4.150-192.168.4.180\n")),(0,r.kt)("p",null,"Et d'appliquer le fichier."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"sudo kubectl apply -f metallb-config.yaml\n")),(0,r.kt)("p",null,"F\xe9liciations \ud83c\udf89 !! L'installation de MetalLB est finie (avouez que c'est plut\xf4t simple)."),(0,r.kt)("h2",{id:"utilisation"},"Utilisation"),(0,r.kt)("p",null,"Pour b\xe9n\xe9ficier de l'attribution automatique d'IP (attribution d'une externalIp) de MetalLB il suffit simplement de renseigner dans votre service Kubernetes le type ",(0,r.kt)("code",null,"LoadBalancer"),"."),(0,r.kt)("p",null,"Comme dans l'exemple ci dessous."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"apiVersion: v1\nkind: Service\nmetadata:\n  name: your-service\nspec:\n  ports:\n  - name: http\n    port: 3000\n    targetPort: 3000\n  selector:\n    app: your-app\n  type: LoadBalancer\n")))}d.isMDXComponent=!0},6234:function(e,t,n){t.Z=n.p+"assets/images/metallb-pods-020c13296fe38e9b9c82b510170c69f6.png"}}]);